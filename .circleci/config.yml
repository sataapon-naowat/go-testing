version: 2.1

orbs:
  go: circleci/go@1.7

jobs:
  build:
    machine:
      image: ubuntu-2004:202010-01

    steps:
      - checkout      

      - run:
          name: download golanglint-ci
          command: curl -sSfL https://raw.githubusercontent.com/golangci/golangci-lint/master/install.sh | sh -s v1.49.0
      - run:
          name: run lint
          command: ./bin/golangci-lint run

      - run:
          name: install docker
          command: |
            sudo apt-get install apt-transport-https ca-certificates curl software-properties-common
            curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
            echo "deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
            sudo apt-get update
            sudo apt-get install docker-ce docker-ce-cli containerd.io
      
      - go/install:
          version: "1.19"
      - go/load-cache
      - go/mod-download
      - go/save-cache

      - run:
          name: docker compose
          command: |
            docker compose up -d
      
      - run:
          name: run go code
          command: |
            go run .
            

workflows:
  continuous-integration:
    jobs:
      - build
